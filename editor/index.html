<html> 
<head> 
    <script src="js/skulpt.min.js" type="text/javascript"></script> 
    <script src="js/skulpt-stdlib.js" type="text/javascript"></script> 
    <script src="js/ace.js" type="text/javascript" charset="utf-8"></script>    
    <script src="js/FileSaver.min.js" type="text/javascript" charset="utf-8"></script>
    
    <style type="text/css" media="screen">
        #editor{
            box-sizing:border-box;
            border-top:2px solid #000;
            border-right:2px solid #000;
            border-left:2px solid #000;
            background-color:#50394c;
            color:#fff;
            padding:10px 10px 5px;
        }        
        #console {
            border: 10 px solid #d3d3d3;
            margin: auto;
            font-size: 14 px;
            width: 100%;
            height: 300 px;
            overflow-y: auto;
            background-color: #000;       
        }  
        .divider {
            background-color: #2F3129;       
        }  
    </style>
    
    <script type="text/javascript">
      function generateCode()
      {
        var code = ace.edit("editor").getValue(); 

        navigator.permissions.query({name: "clipboard-write"}).then(result => {
          if (result.state == "granted" || result.state == "prompt") {
            navigator.clipboard.writeText(code);
            alert("Code copied to clipboard");
            /* write to the clipboard now */
          }
          else
          {
            alert("Unable to copy code to clipboard. Please allow the appropriate permissions.");
          }
        });
      }

      function saveCode() {
          var code = ace.edit("editor").getValue();
          var file = new File([code], "my_code.py", {type: "text/plain;charset=utf-8"});
          saveAs(file);    
      }      
      
      function outputf(n) {
          pyConsole.appendChild(createColouredTextSpanElement(n));
          pyConsole.scrollTop = document.getElementById("console").scrollHeight;
      }
          
      function createColouredTextSpanElement(n) {
          let t = document.createTextNode(n);        
          let e = document.createElement("span");
          e.style.color = "rgb(255,255,255)";        
          e.style.fontSize = "14pt";
          e.appendChild(t);        
          return e;
      }

      function inputf(n) {
          return new Promise((function(n, e) {                    
                      let t = document.createElement("span");
                      t.setAttribute("contenteditable", "true");
                      t.style.color = "rgb(255,255,255)";
                      t.style.fontSize = "14pt";
                      t.style.outlineStyle = "none";
                      pyConsole.appendChild(t);
                      t.focus();
                      t.addEventListener("keyup", (function(e) {
                          e.preventDefault();
                          if (e.key ==="Enter") {
                              userResponse = t.innerText.replace(/\n+$/, "");
                              t.remove();
                              outputf(userResponse);
                              outputf("\n");
                              n(userResponse);
                          }
                      }))
                  }))
      }
      
      function sleep(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
      }
      
      async function lineStepper(susp)
      {
          checkForStop();
          try {
              
              editor.gotoLine(susp.child.$lineno);            
              // don't pause on the first line
              if (just_run) just_run = false            
              else await sleep(1000);            

              // Return an already-resolved promise in this case
              return Promise.resolve(susp.resume());
          } catch(e) {
              return Promise.reject(e);
          }    
      }
      
      function checkForStop() {
          if (_stopped)
          {   
              throw 'stopped!';
          }
      }
      
      function runSkulpt(stepRun) {
          var code = ace.edit("editor").getValue(); 
          
          editor.setReadOnly(true); 
          
          _stopped = false;
          
          // clear the console
          pyConsole.innerHTML = "";
          just_run = true;
          
          Sk.configure({
              output: outputf,
              inputfun: inputf,
              inputfunTakesPrompt: false,
              debugging: stepRun,
              killableWhile: true,
              //breakpoints: function() { return true; },
              __future__: Sk.python3
          });
              
          var handlers = {};
          handlers["*"] = checkForStop;            
          if (stepRun) {        
              editor.setTheme("ace/theme/gob");
              handlers["Sk.debug"] = lineStepper;
              handlers["Sk.delay"] = lineStepper;
          }

          stopButton.style.display = "inline";
          stepButton.style.display = "none";
          runButton.style.display = "none";
              
          var e = Sk.misceval.asyncToPromise((function() {
              return Sk.importMainWithBody("<stdin>", false, code, true)})
              , handlers);
          
          e.catch((function(err) {
              if (err.message) {
                  outputf(err.message + "\n");
                  outputf(err.stack);
                  if (err.nativeError) {
                      outputf(err.nativeError.message + "\n");
                      outputf(err.nativeError.stack);
                  }
              }
              else {
                  outputf(err.toString() + "\n");
                  if (err.stack)
                  {
                      outputf(err.stack);
                  }                   
          }}));
          e.finally((function() { 
              stopSkulpt() 
          } ));
      }
      
      function stopSkulpt() {
          editor.setReadOnly(false); 
          editor.setTheme("ace/theme/monokai");
          just_run = false;

          stopButton.style.display = "none";          
          runButton.style.display = "inline";          
          if (nostep != null && nostep.length > 0)
          {        
            stepButton.style.display = "none";
          }    
          else
          {
            stepButton.style.display = "inline";
          }             
      }
    </script>     
</head> 

<body> 
 
    <div id="container" style = "width:800px; margin: 0 auto"> 
    <form style = "width:400px; margin: 20px auto;text-align: center"> 
        <button id="runButton" type="button" onclick="runSkulpt(false);">Run</button> 
        <button id="stepButton" type="button" onclick="runSkulpt(true);">Step-Run</button> 
        <button id="stopButton" type="button" onclick="_stopped=true;">Stop</button>
        <button id="copyButton" type="button" onclick="generateCode();">Copy Code</button> 
        <button id="saveButton" type="button" onclick="saveCode();">Save Code</button> 
    </form>       
        <div id="editor" style="height: 400px">
        </div>
        <div id="split1" class="divider" style="height: 10px"></div>    
        <pre id="console" style="height: 200px"></pre>        
    </div>
    
    <!---- setting up global vars for the editor and console etc. ----->
    <script>
      urlParams = new URLSearchParams(window.location.search);
      esc = urlParams.get('code')

      if (esc == null || esc.length == 0)
      {
        esc = "n%2520%253D%2520int%28input%28%2522number%2520of%2520times%253A%2522%29%29%250Ai%2520%253D%25200%250Awhile%2520i%2520%253C%2520n%253A%250A%2520%2520%2520%2520print%28i%29%250A%2520%2520%2520%2520i%2520%252B%253D%25201%250Aprint%28%2522all%2520done%21%21%2522%29";
      }

      codeString = decodeURIComponent(unescape(esc));
      document.getElementById("editor").innerHTML = codeString;

      var pyConsole = document.getElementById("console"); 
      
      var editor = ace.edit("editor");
      editor.setTheme("ace/theme/monokai");
      editor.session.setMode("ace/mode/python");        
      editor.setOptions({  
        fontSize: "14pt"
      });        
      editor.setHighlightActiveLine(true);

      demo = urlParams.get('demo')
      if (demo != null && demo.length > 0)
      {
        var consoleDiv = document.getElementById("console"); 
        var editorDiv = document.getElementById("editor");
        var dividerDiv = document.getElementById("split1");

        editorDiv.before(dividerDiv);
        dividerDiv.before(consoleDiv);
      }      

      var saveButton = document.getElementById("saveButton"); 
      var stepButton = document.getElementById("stepButton"); 
      var copyButton = document.getElementById("copyButton");       
      var stopButton = document.getElementById("stopButton");  

      stopButton.style.display = "none";  
      save = urlParams.get('save')
      if (save != null && save.length > 0)
      {        
        saveButton.style.display = "inline";
      }    
      else
      {        
        saveButton.style.display = "none";
      }        

      nostep = urlParams.get('nostep')
      if (nostep != null && nostep.length > 0)
      {        
        stepButton.style.display = "none";
      }    
      else
      {
        stepButton.style.display = "inline";
      }   

      nocopy = urlParams.get('nocopy')
      if (nocopy != null && nocopy.length > 0)
      {
        copyButton.style.display = "none";
      }    
      else
      {
        copyButton.style.display = "inline";
      }                   
      
      var just_run = false;
      var _stopped = false;

    </script>    

</body> 

</html> 