<html> 
<head> 
    <script src="js/skulpt.min.js" type="text/javascript"></script> 
    <script src="js/skulpt-stdlib.js" type="text/javascript"></script> 
    <script src="js/csinsc.js" type="text/javascript" charset="utf-8"></script>    
    <script src="js/ace.js" type="text/javascript" charset="utf-8"></script>    
    <script src="js/FileSaver.min.js" type="text/javascript" charset="utf-8"></script>
    
    <style type="text/css" media="screen">
        #editor{
            box-sizing:border-box;
            border-top:2px solid #000;
            border-right:2px solid #000;
            border-left:2px solid #000;
            background-color:#50394c;
            color:#fff;
            padding:10px 10px 5px;
        }        
        #console {
            border: 10 px solid #d3d3d3;
            margin: auto;
            font-size: 14 px;
            width: 100%;
            height: 300 px;
            overflow-y: auto;
            background-color: #000;       
        }  
        .divider {
            background-color: #2F3129;       
        }  
    </style>
    
    <script type="text/javascript">   
        function generateCode()
        {
            var code = ace.edit("editor").getValue(); 

            navigator.permissions.query({name: "clipboard-write"}).then(result => {
                if (result.state == "granted" || result.state == "prompt") {
                    navigator.clipboard.writeText(code);
                    alert("Code copied to clipboard");
                    /* write to the clipboard now */
                }
                else
                {
                    alert("Unable to copy code to clipboard. Please allow the appropriate permissions.");
                }
            });
        }
        
        function resetCanvas()
        {
            window.cancelAnimationFrame(Sk.builtins.animationFrameRequest);
            var canvas = document.getElementById("pyangelo");
            var ctx = canvas.getContext('2d');         
            ctx.fillStyle = "rgb(127, 127, 127)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
      
        var filename = null;
        function saveCode() {
            var code = ace.edit("editor").getValue();
            var file = new File([code], filename + ".py", {type: "text/plain;charset=utf-8"});
            saveAs(file);    
        }
       
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        async function lineStepper(susp)
        {
            checkForStop();
            try {
                
                editor.gotoLine(susp.child.$lineno);            
                // don't pause on the first line                
                if (just_run) just_run = false            
                else {
                    await sleep(1000);            
                }

                // Return an already-resolved promise in this case
                return Promise.resolve(susp.resume());
            } catch(e) {
                return Promise.reject(e);
            }    
        }
        
        function checkForStop() {
            if (_stopped)
                throw 'stopped!';
        }
        
        function logError(text)
        {
            outputf(Sk.builtins.RESET + Sk.builtins.RED + text + "\n" + Sk.builtins.RESET);
        }
        
        function logInfo(text)
        {
            outputf(Sk.builtins.RESET + Sk.builtins.BLUE + text + "\n" + Sk.builtins.RESET);
        }
        
        function runSkulpt(stepRun) {
            var code = ace.edit("editor").getValue(); 
            
            editor.setReadOnly(true); 
            
            _stopped = false;
            stopButton.style.display = "inline";
            stepButton.style.display = "none";
            runButton.style.display = "none";            
            
            // clear the console
            pyConsole.innerHTML = "";
            just_run = true;
            
            Sk.configure({
                output: outputf,
                inputfun: inputf,
                inputfunTakesPrompt: false,
                debugging: true, //stepRun ? true : false,
                killableWhile: true,
                //breakpoints: function() { return true; },
                __future__: Sk.python3
            });
            
            Sk.onAfterCompile = doGoto;
                
            var handlers = {};
            handlers["*"] = checkForStop;            
            if (stepRun) {        
                editor.setTheme("ace/theme/gob");
                handlers["Sk.debug"] = lineStepper;
                handlers["Sk.delay"] = lineStepper;

            }
                           
            var e = Sk.misceval.asyncToPromise((function() {
                return Sk.importMainWithBody("<stdin>", true, code, true)})
                , handlers);
            
            e.catch((function(err) {
                if (err.message) {
                   logError(err.message);
                   logError(err.stack);
                   if (err.nativeError) {
                       logError(err.nativeError.message);
                       logError(err.nativeError.stack);
                   }
                }
                else {
                   logError(err.toString());
                   if (err.stack)
                   {
                       logError(err.stack);
                   }                   
            }}));
            e.finally((function() { 
                stopSkulpt(); 
            } ));
        }
        
        function stopSkulpt() {
            editor.setReadOnly(false); 
            editor.setTheme("ace/theme/monokai");
            just_run = false;
            
            stopButton.style.display = "none";          
            runButton.style.display = "inline";          
            if (nostep != null && nostep.length > 0)
            {        
                stepButton.style.display = "none";
            }    
            else
            {
                stepButton.style.display = "inline";
            }        
            resetCanvas();                     
        }
        
        function stopEditor()
        {
            _stopped = true;
            if (inputElement != null)
            {
                // if stopped during an input...
                stopSkulpt();
                userResponse = inputElement.innerText.replace(/\n+$/, "");
                inputElement.remove();
                outputf(userResponse);
                outputf("\n"); 
                // TODO: fold this into the main promise/catch process?
                inputElement = null;
                logError("stopped!");                
                throw "stopped!";
            }                       
        }
    </script>     
</head> 

<body> 
 
    <div id="container" style = "width:900px; margin: 0 auto"> 
        <form style = "width:400px; margin: 20px auto;text-align: center"> 
            <button id="runButton" type="button" onclick="runSkulpt(false);">Run</button> 
            <button id="stepButton" type="button" onclick="runSkulpt(true);">Step-Run</button> 
            <button id="stopButton" type="button" onclick="stopEditor();">Stop</button>
            <button id="copyButton" type="button" onclick="generateCode();">Copy Code</button> 
            <button id="saveButton" type="button" onclick="saveCode();">Save Code</button>         
            <button id="loadButton" type="button" onclick="document.getElementById('file-input').click(); return false;">Load Code</button> 
            <button id="URLButton" type="button" onclick="generateURL();">Generate Link</button> 
        </form>  
        <div style = "display: flex; flex-direction:row;">
            <div style = "width: 75%; border: 1px solid black">
                <div id="editor" style="height: 400px">from pyangelo import *
print(HL_RED + BLACK + BLUE + "hello, " + ITALICS + BOLD + UNDERLINE + GREEN + "universe!")
print("howfore art thou?")
                </div>
                <div class="divider" style="height: 10px"></div>    
                <pre id="console" style="height: 140px" onclick="if (inputElement != null) inputElement.focus();"></pre>        
            </div>
            <div>
                <canvas id="pyangelo" height = 550 width = 326 style="border: 1px solid black; flex: 1 1 0px;" tabindex='1'></canvas>
            </div>
        </div>
        
    </div>
    <input id="file-input" type="file" name="name" style="display: none;"/>
    
    <!---- setting up global vars for the editor and console etc. ----->
    <script>
        //Encode
        function utoa(str) {
            return /*window.btoa*/(escape(encodeURIComponent(str)));
        }
        //Decode
        function atou(str) {
            return decodeURIComponent(unescape(/*window.atob*/(str)));
        }    
        function generateURL()
        {
            ta = document.getElementById("code");
            
            var url = window.location.href.split("?")[0];


            //url = url + "?code=" + utoa(ace.edit("editor").getValue());
            url = url + "?URL=1&code=" + encodeToUTF16(ace.edit("editor").getValue());

            navigator.permissions.query({name: "clipboard-write"}).then(result => {
              if (result.state == "granted" || result.state == "prompt") {
                navigator.clipboard.writeText(url);
                alert("URL copied to clipboard");
                /* write to the clipboard now */
              }
              else
              {
                alert("Unable to copy URL to clipboard. Please allow the appropriate permissions.");
              }
            });
        }
  
        urlParams = new URLSearchParams(window.location.search);
        esc = urlParams.get('code')
                
        if (esc != null && esc.length > 0)
        {            
            //codeString = atou(esc);
            codeString = decodeFromUTF16(esc);
            document.getElementById("editor").innerHTML = codeString;            
        }
      
        var pyConsole = document.getElementById("console"); 
        
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/python");        
        editor.setOptions({  
          fontSize: "12pt"
        });        
        editor.setHighlightActiveLine(true);
        
        function userLoadCode(event) {
            var files = event.target.files;
            var file = null;
            if (files.length > 0) file = files[0];
            else return;
            var reader = new FileReader();
            reader.onload = (function (theFile) {
                return function (e) {
                    editor.setValue(e.target.result, -1);
                };
            })(file);
            reader.readAsText(file);
        }

        document.getElementById('file-input').addEventListener('change', userLoadCode, false);            
        
        demo = urlParams.get('demo')
        if (demo != null && demo.length > 0)
        {
            var consoleDiv = document.getElementById("console"); 
            var editorDiv = document.getElementById("editor");
            var dividerDiv = document.getElementById("split1");

            editorDiv.before(dividerDiv);
            dividerDiv.before(consoleDiv);
        }      

        var saveButton = document.getElementById("saveButton"); 
        var loadButton = document.getElementById("loadButton"); 
        var stepButton = document.getElementById("stepButton"); 
        var copyButton = document.getElementById("copyButton");       
        var stopButton = document.getElementById("stopButton");  
        var URLButton = document.getElementById("URLButton");  

        stopButton.style.display = "none";  
        save = urlParams.get('save')
        if (save != null && save.length > 0)
        {        
            saveButton.style.display = "inline";
            loadButton.style.display = "inline";
        }    
        else
        {        
            saveButton.style.display = "none";
            loadButton.style.display = "none";
        }      

        
        filename = urlParams.get('name')
        if (filename == null || filename.length == 0)
        {        
            filename = "my_code";
        }    
        
        nostep = urlParams.get('nostep')
        if (nostep != null && nostep.length > 0)
        {        
            stepButton.style.display = "none";
        }    
        else
        {
            stepButton.style.display = "inline";
        }   

        nocopy = urlParams.get('nocopy')
        if (nocopy != null && nocopy.length > 0)
        {
            copyButton.style.display = "none";
        }    
        else
        {
            copyButton.style.display = "inline";
        }           

        URLButton.style.display = "none";  
        urlButtonOn = urlParams.get('URL')
        if (urlButtonOn != null && urlButtonOn.length > 0)
        {        
            URLButton.style.display = "inline";
        }    
        else
        {        
            URLButton.style.display = "none";
        }          
        
        project = urlParams.get('project');
        if (project != null && project.length > 0)
        {
            var client = new XMLHttpRequest();
            client.open("GET", "projects/" + project + ".py");
            client.onreadystatechange = function () {
                if (client.readyState == 4) {
                    project_src = client.responseText;
                    editor.setValue(project_src, -1);
                }
            };
            client.send();            
        }    
        
        var just_run = false;
        var _stopped = false;
        var inputElement = null;
        
        resetCanvas();
        
    </script>    

</body> 

</html> 