<html> 
<head> 
    <script src="../dist/skulpt.min.js" type="text/javascript"></script> 
    <script src="../dist/skulpt-stdlib.js" type="text/javascript"></script> 
    <script src="js/ace.js" type="text/javascript" charset="utf-8"></script>    
    <script src="js/FileSaver.min.js" type="text/javascript" charset="utf-8"></script>
    
    <style type="text/css" media="screen">
        #editor{
            box-sizing:border-box;
            border-top:2px solid #000;
            border-right:2px solid #000;
            border-left:2px solid #000;
            background-color:#50394c;
            color:#fff;
            padding:10px 10px 5px;
        }        
        #console {
            border: 10 px solid #d3d3d3;
            margin: auto;
            font-size: 14 px;
            width: 100%;
            height: 300 px;
            overflow-y: auto;
            background-color: #000;       
        }  
        .divider {
            background-color: #2F3129;       
        }  
    </style>
    
    <script type="text/javascript">   
        function save() {
            var code = ace.edit("editor").getValue();
            var file = new File([code], "my_code.py", {type: "text/plain;charset=utf-8"});
            saveAs(file);    
        }
        
        function outputf(n) {
            var text = "";
            var color = "rgb(255,255,255)";
            for(i = 0; i < n.length; i++)
            {

                if (n[i] == "\u001b")
                {
                    if (text.length > 0)
                        pyConsole.appendChild(createColouredTextSpanElement(text, color));                
                    text = "";
                    i++;
                    switch (n[i])
                    {
                        case '1':
                            color = "red";
                            break;
                        case '2':
                            color = "green";
                            break;
                        case '3':
                            color = "blue";
                            break;                           
                        default:
                            color = "white";
                    }
                    i++;
                }
                text += n[i];
                
            }
            if (text.length > 0)
                pyConsole.appendChild(createColouredTextSpanElement(text, color));                           
            
            pyConsole.scrollTop = document.getElementById("console").scrollHeight;
        }
            
        function createColouredTextSpanElement(n, color) {
            let t = document.createTextNode(n);        
            let e = document.createElement("span");
            e.style.color = color;        
            e.style.fontSize = "14pt";
            e.appendChild(t);        
            return e;
        }
        
        function doGoto(name, code)
        {
            var destCode = code;
            if (name == "<stdin>")            
            {
                console.log(code);
                var labels = {};
                
                var blocks = [];
                                
                // grabbing all the blocks and their character indices in the code
                var casePattern = /case \d+:/g;                
                var matches = code.matchAll(casePattern);
                var numBlocks = 0;
                var start = 0;
                var end = 0;
                for (match of matches)
                {
                    if (numBlocks == 0)
                    {
                        start = match.index;
                    }
                    else
                    {
                        end = match.index;
                        blocks.push([start, end - start]);
                        start = end;
                        
                    }
                    numBlocks++;
                }
                if (numBlocks > 0)
                {
                    blocks.push([start, code.length - start - 1]);
                }
                
                // pass 1:
                // finding all the label blocks, grabbing their block numbers
                // and populating the lookup table with them
                for (i = 0; i < blocks.length; i++)
                {
                    block = code.substr(blocks[i][0], blocks[i][1]);
                    var blockNumberPattern = /case (\d+)/g;  
                    var blockNumberMatches = block.matchAll(blockNumberPattern);
                    for (blockNumberMatch of blockNumberMatches)
                    {
                        var labalNamePattern = /label (.+)/g;
                        var labalNameMatches = block.matchAll(labalNamePattern);
                        for (labalNameMatch of labalNameMatches)
                        {
                            labels[labalNameMatch[1].trim()] = blockNumberMatch[1];
                            
                            // deleting suspensions code associated with label code
                            var suspensionsPattern = /var \$loadname[\S\s]+?\$blk=\d+;/g;
                            var suspensionsMatches = block.matchAll(suspensionsPattern);   

                            for (suspensionMatch of suspensionsMatches)
                            {
                                destCode = destCode.replace(suspensionMatch[0], "");                                                          
                            }
                            
                            // deleting suspensions code in the next block too
                            if (i < blocks.length - 1)
                            {
                                block = code.substr(blocks[i + 1][0], blocks[i + 1][1]);
                                var suspensionsPattern = /if \(\$ret[\s\S]+=\$ret;/g;
                                var suspensionsMatches = block.matchAll(suspensionsPattern);   

                                for (suspensionMatch of suspensionsMatches)
                                {
                                    destCode = destCode.replace(suspensionMatch[0], "");                                                          
                                }                            
                            }
                        }
                    }
                }
                
                // pass 2:
                // fill in goto statements
                for (i = 0; i < blocks.length; i++)
                {
                    block = code.substr(blocks[i][0], blocks[i][1]);
                    var gotoPattern = patt2 = /\/\/\s+goto (.+)[\s\S]+/g;
                    var gotoMatches = block.matchAll(gotoPattern);
                    for (gotoMatch of gotoMatches)
                    {
                        var lineNo = labels[gotoMatch[1].trim()];
                        // replace everything from the case statement onwards (exclusively) with the blk jump
                        destCode = destCode.replace(gotoMatch[0], "$blk=" + lineNo + ";/* goto */continue;");
                    }
                }                                
            }
            
            return destCode;
        }

        function inputf(n) {
            inputPromise = new Promise((function(n, e) {                    
                        inputElement = document.createElement("span");
                        inputElement.setAttribute("contenteditable", "true");
                        inputElement.style.color = "rgb(255,255,255)";
                        inputElement.style.fontSize = "14pt";
                        inputElement.style.outlineStyle = "none";
                        pyConsole.appendChild(inputElement);
                        inputElement.focus();
                        inputElement.addEventListener("keyup", (function(e) {
                            e.preventDefault();
                            if (e.key ==="Enter") {
                                userResponse = inputElement.innerText.replace(/\n+$/, "");
                                inputElement.remove();
                                inputElement = null;
                                outputf(userResponse);
                                outputf("\n");
                                n(userResponse);
                            }
                        }))
                    }));
            return inputPromise;
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        async function lineStepper(susp)
        {
            checkForStop();
            try {
                
                editor.gotoLine(susp.child.$lineno);            
                // don't pause on the first line
                if (just_run) just_run = false            
                else await sleep(1000);            

                // Return an already-resolved promise in this case
                return Promise.resolve(susp.resume());
            } catch(e) {
                return Promise.reject(e);
            }    
        }
        
        function checkForStop() {
            if (_stopped)
                throw 'stopped!';
        }
        
        function runSkulpt(stepRun) {
            var code = ace.edit("editor").getValue(); 
            
            editor.setReadOnly(true); 
            
            _stopped = false;
            
            // clear the console
            pyConsole.innerHTML = "";
            just_run = true;
            
            Sk.configure({
                output: outputf,
                inputfun: inputf,
                inputfunTakesPrompt: false,
                debugging: true, //stepRun ? true : false,
                killableWhile: true,
                //breakpoints: function() { return true; },
                __future__: Sk.python3
            });
            
            Sk.onAfterCompile = doGoto;
                
            var handlers = {};
            handlers["*"] = checkForStop;            
            if (stepRun) {        
                editor.setTheme("ace/theme/gob");
                handlers["Sk.debug"] = lineStepper;
                handlers["Sk.delay"] = lineStepper;

            }
                           
            var e = Sk.misceval.asyncToPromise((function() {
                return Sk.importMainWithBody("<stdin>", true, code, true)})
                , handlers);
            
            e.catch((function(err) {
                if (err.message) {
                   outputf(err.message + "\n");
                   outputf(err.stack);
                   if (err.nativeError) {
                       outputf(err.nativeError.message + "\n");
                       outputf(err.nativeError.stack);
                   }
                }
                else {
                   outputf(err.toString() + "\n");
                   if (err.stack)
                   {
                       outputf(err.stack);
                   }                   
            }}));
            e.finally((function() { 
                stopSkulpt(); 
            } ));
        }
        
        function stopSkulpt() {
            editor.setReadOnly(false); 
            editor.setTheme("ace/theme/monokai");
            just_run = false;
         
        }
        
        function stopEditor()
        {
            _stopped = true;
            if (inputElement != null)
            {
                stopSkulpt();
                userResponse = inputElement.innerText.replace(/\n+$/, "");
                                                inputElement.remove();
                                                outputf(userResponse);
                                                outputf("\n"); 
                // TODO: fold this into the main promise/catch process?
                inputElement = null;
                outputf("stopped");
                throw "stopped";
            }           
        }
    </script>     
</head> 

<body> 
 
    <div id="container" style = "width:800px; margin: 0 auto">
    <h1 style="text-align: center">Coding Exercise # 1</h3>     
    <form style = "width:400px; margin: 20px auto;text-align: center"> 
        <button type="button" onclick="runSkulpt(false);">Run</button> 
        <button type="button" onclick="runSkulpt(true);">Step-Run</button> 
        <button type="button" onclick="stopEditor();">Stop</button>
        <button type="button" onclick="save();">Save</button> 
    </form>       
        <div id="editor" style="height: 400px">from pyangelo import *

i = 1
name = input("name:")
while True:
    clearScreen(i * 10, 0, 255, 1)  
    drawRect(10, 10, 50, 70, 5, GREEN)
    fillRect(20, 300, 100, 50, BLUE)
    if isKeyPressed('a'):
        printAt("helloðŸ˜‹", 100, 200)
        print("released")
    i = (i + 1) % 25

print("all done")
        </div>
        <div class="divider" style="height: 10px"></div>    
        <pre id="console" style="height: 200px" onfocus="if (inputElement != null) inputElement.focus();"></pre>        
        <canvas id="pyangelo" height = 480 width = 640 style="border: 1px solid black;" tabindex='1'></canvas>  
    </div>
    
    <!---- setting up global vars for the editor and console etc. ----->
    <script>
        var pyConsole = document.getElementById("console"); 
        
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/python");        
        editor.setOptions({  
          fontSize: "14pt"
        });        
        editor.setHighlightActiveLine(true);
        
        var just_run = false;
        var _stopped = false;
        var inputElement = null;
     
    </script>    

</body> 

</html> 