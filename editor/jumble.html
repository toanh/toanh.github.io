<html> 
<head> 
    <script src="js/skulpt.min.js" type="text/javascript"></script> 
    <script src="js/skulpt-stdlib.js" type="text/javascript"></script>     
    <script src="js/sortable-min.js" type="text/javascript" charset="utf-8"></script>    
    
    <style type="text/css" media="screen">
        .list > div {
            min-height: 12px;
            border-style: solid;
            border-width: 1px;
            text-align: left;
            line-height: 12px;
            font-size: 12px;
            font-family: Helvetica;
        }

        .half {
            display: inline-block;
            width: 49%;
            padding: 0;
            margin: 0;
            vertical-align: top;
        }    
        #console {
            border: 10 px solid #d3d3d3;
            margin: auto;
            font-size: 14 px;
            width: 100%;
            height: 300 px;
            overflow-y: auto;
            background-color: #000;       
        }  
        .divider {
            background-color: #2F312900;       
        }  
    </style>
    
    <script type="text/javascript">          
        function outputf(n) {
            pyConsole.appendChild(createColouredTextSpanElement(n));
            pyConsole.scrollTop = document.getElementById("console").scrollHeight;
        }
            
        function createColouredTextSpanElement(n) {
            let t = document.createTextNode(n);        
            let e = document.createElement("span");
            e.style.color = "rgb(255,255,255)";        
            e.style.fontSize = "14pt";
            e.appendChild(t);        
            return e;
        }

        function inputf(n) {
            return new Promise((function(n, e) {                    
                        let t = document.createElement("span");
                        t.setAttribute("contenteditable", "true");
                        t.style.color = "rgb(255,255,255)";
                        t.style.fontSize = "14pt";
                        t.style.outlineStyle = "none";
                        pyConsole.appendChild(t);
                        t.focus();
                        t.addEventListener("keyup", (function(e) {
                            e.preventDefault();
                            if (e.key ==="Enter") {
                                userResponse = t.innerText.replace(/\n+$/, "");
                                t.remove();
                                outputf(userResponse);
                                outputf("\n");
                                n(userResponse);
                            }
                        }))
                    }))
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        async function lineStepper(susp)
        {
            checkForStop();
            try {
                
                //editor.gotoLine(susp.child.$lineno);            
                // don't pause on the first line
                if (just_run) just_run = false            
                else await sleep(1000);            

                // Return an already-resolved promise in this case
                return Promise.resolve(susp.resume());
            } catch(e) {
                return Promise.reject(e);
            }    
        }
        
        function checkForStop() {
            if (_stopped)
            {   
                throw 'stopped!';
            }
        }
        
        function runSkulpt(stepRun) {
            var list = document.getElementById("list1").children;
            code = "";

            for (i = 0; i < list.length; i ++)
            {
              code += list[i].children[0].innerText;
              code += "\n";
            }
            
            _stopped = false;
            
            // clear the console
            pyConsole.innerHTML = "";
            just_run = true;
            
            Sk.configure({
                output: outputf,
                inputfun: inputf,
                inputfunTakesPrompt: false,
                debugging: stepRun,
                killableWhile: true,
                //breakpoints: function() { return true; },
                __future__: Sk.python3
            });
                
            var handlers = {};
            handlers["*"] = checkForStop;            
            if (stepRun) {        
                handlers["Sk.debug"] = lineStepper;
                handlers["Sk.delay"] = lineStepper;
            }
                
            var e = Sk.misceval.asyncToPromise((function() {
                return Sk.importMainWithBody("<stdin>", true, code, true)})
                , handlers);
            
            e.catch((function(err) {
                if (err.message) {
                   outputf(err.message + "\n");
                   outputf(err.stack);
                   if (err.nativeError) {
                       outputf(err.nativeError.message + "\n");
                       outputf(err.nativeError.stack);
                   }
                }
                else {
                   outputf(err.toString() + "\n");
                   if (err.stack)
                   {
                       outputf(err.stack);
                   }                   
            }}));
            e.finally((function() { 
                stopSkulpt() 
            } ));
        }
        
        function stopSkulpt() {
            just_run = false;
        }
    </script>     
</head> 

<body> 
 
    <div id="container" style = "width:800px; margin: 0 auto">
        <h1 style="text-align: center">Code Jumble # 1</h3>     
        <form style = "width:400px; margin: 20px auto;text-align: center"> 
            <button type="button" onclick="runSkulpt(false);">Run</button> 
        </form>       
        <div class="list" id="list1"></div>   
        <div class="divider" style="height: 10px"></div>  
        <pre id="console" style="height: 200px"></pre>         
    </div>
    
    <!---- setting up global vars for the editor and console etc. ----->
    <script>
        var pyConsole = document.getElementById("console");      

        urlParams = new URLSearchParams(window.location.search);
        esc = urlParams.get('code')
        
        var codeString;

        if (esc == null || esc.length == 0)
        {
            
            codeString = "   print('Hi to myself!')\nif name == 'me':\nname = input('Enter your name:')\nelse:\n   print('Hello ' + name + '!')";
        }
        else
        {
            codeString = decodeURIComponent(unescape(esc));
        }
        
        lines = codeString.split("\n");
        for (i = 0; i < lines.length; i++)
        {
            var codeLine = document.createElement("div");   
            var preElement = document.createElement("pre");            
            var textnode = document.createTextNode(lines[i]);         

            preElement.appendChild(textnode);    
            codeLine.appendChild(preElement);  
            document.getElementById("list1").appendChild(codeLine);  
        }
        
        new Sortable(document.getElementById('list1'));
    </script>    

</body> 

</html> 