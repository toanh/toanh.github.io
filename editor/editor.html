<html> 
<head> 
    <script src="js/skulpt.min.js" type="text/javascript"></script> 
    <script src="js/skulpt-stdlib.js" type="text/javascript"></script> 
    <script src="js/pygmi.js" type="text/javascript" charset="utf-8"></script>   
    <script src="js/console.js" type="text/javascript" charset="utf-8"></script>    
    <script src="js/ace.js" type="text/javascript" charset="utf-8"></script>    
    <script src="js/FileSaver.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/split.min.js" type="text/javascript" charset="utf-8"></script>
    
    <style type="text/css" media="screen">
        #editor{
            box-sizing:border-box;
            border-top:2px solid #000;
            border-right:2px solid #000;
            border-left:2px solid #000;
            background-color:#50394c;
            color:#fff;
            padding:10px 10px 5px;
        }        
        #console {
            border: 10 px solid #d3d3d3;
            margin: auto;
            font-size: 14 px;
            width: 100%;
            height: 300 px;
            overflow-y: auto;
            background-color: #000;       
        }  
        .split {
            display: flex;
            flex-direction: row;
        }
        .gutter {
            background-color: #eee;
            background-repeat: no-repeat;
            background-position: 50%;
        }        
        .gutter.gutter-vertical {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAFAQMAAABo7865AAAABlBMVEVHcEzMzMzyAv2sAAAAAXRSTlMAQObYZgAAABBJREFUeF5jOAMEEAIEEFwAn3kMwcB6I2AAAAAASUVORK5CYII=');
            cursor: row-resize;
        }        
        .gutter.gutter-horizontal {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==');
            cursor: col-resize;
        }        
    </style>
    
    <script type="text/javascript"> 
        function generateEmbed()
        {
            ta = document.getElementById("code");
            
            var url = window.location.href.split("?")[0];

            url = url + "?code=" + encodeToUTF16(ace.edit("editor").getValue());
            
            embed = "<iframe src=\"" + url + "\" width = 960 height = 640 style='border:1px solid #808080;'></iframe>";

            navigator.permissions.query({name: "clipboard-write"}).then(result => {
              if (result.state == "granted" || result.state == "prompt") {
                navigator.clipboard.writeText(embed);
                alert("Embed code copied to clipboard");
              }
              else
              {
                alert("Unable to copy embed code to clipboard. Please allow the appropriate permissions.");
              }
            });
        }
        
        function generateURL()
        {
            ta = document.getElementById("code");
            
            var url = window.location.href.split("?")[0];

            url = url + "?code=" + encodeToUTF16(ace.edit("editor").getValue());

            navigator.permissions.query({name: "clipboard-write"}).then(result => {
              if (result.state == "granted" || result.state == "prompt") {
                navigator.clipboard.writeText(url);
                alert("URL copied to clipboard");
              }
              else
              {
                alert("Unable to copy URL to clipboard. Please allow the appropriate permissions.");
              }
            });
        }
        
        function copyCode()
        {
            var code = ace.edit("editor").getValue(); 

            navigator.permissions.query({name: "clipboard-write"}).then(result => {
                if (result.state == "granted" || result.state == "prompt") {
                    navigator.clipboard.writeText(code);
                    alert("Code copied to clipboard");
                }
                else
                {
                    alert("Unable to copy code to clipboard. Please allow the appropriate permissions.");
                }
            });
        }
                
        function resetCanvas()
        {
            window.cancelAnimationFrame(Sk.builtins.animationFrameRequest);
            var canvas = document.getElementById("pyangelo");
            var ctx = canvas.getContext('2d');         
            ctx.fillStyle = "rgb(127, 127, 127)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
              
        function saveCode(filename) {
            var code = ace.edit("editor").getValue();
            var file = new File([code], filename + ".py", {type: "text/plain;charset=utf-8"});
            saveAs(file);    
        }
       
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        var justDelayed = false;
        async function lineStepper(susp)
        {
            checkForStop();
            try {
                
                editor.gotoLine(susp.child.$lineno);            
                // don't pause on the first line                
                if (just_run) just_run = false            
                else {
                    if (susp.data.type == "Sk.delay")
                    {
                        if (!justDelayed)
                        {
                            justDelayed = true;
                            await sleep(1000);    
                        }
                        else
                        {
                            justDelayed = false;
                        }
                    }
                    else
                    {
                        await sleep(1000);  
                        justDelayed = false;
                    }
                            
                }

                // Return an already-resolved promise in this case
                return Promise.resolve(susp.resume());
            } catch(e) {
                return Promise.reject(e);
            }    
        }
        
        function checkForStop() {
            if (_stopped)
                throw 'Stopped!';
        }
        
        function logError(text)
        {
            outputf(Sk.builtins.RESET + Sk.builtins.RED + text + "\n" + Sk.builtins.RESET);
        }
               
        function runSkulpt(stepRun) {
            var code = ace.edit("editor").getValue(); 
            
            code = pygmify(code);
            
            editor.setReadOnly(true); 
            
            _stopped = false;
            stopButton.style.display = "inline";
            stepButton.style.display = "none";
            runButton.style.display = "none";            
            
            // clear the console
            pyConsole.innerHTML = "";
            just_run = true;
            
            resetConsole();
            
            Sk.configure({
                output: outputf,
                inputfun: inputf,
                inputfunTakesPrompt: false,
                debugging: true, //stepRun ? true : false,
                killableWhile: true,
                //breakpoints: function() { return true; },
                __future__: Sk.python3
            });
            
            //Sk.onAfterCompile = doGoto;
               
            var handlers = {};
            handlers["*"] = checkForStop;            
            if (stepRun) {        
                editor.setTheme("ace/theme/gob");
                handlers["Sk.debug"] = lineStepper;
                handlers["Sk.delay"] = lineStepper;

            }
                           
            var e = Sk.misceval.asyncToPromise((function() {
                return Sk.importMainWithBody("<stdin>", true, code, true)})
                , handlers);
            
            e.catch((function(err) {
                if (err.message) {
                   logError(err.message);
                   logError(err.stack);
                   if (err.nativeError) {
                       logError(err.nativeError.message);
                       logError(err.nativeError.stack);
                   }
                }
                else {
                   logError(err.toString());
                   if (err.stack)
                   {
                       logError(err.stack);
                   }                   
            }}));
            e.finally((function() { 
                stopSkulpt(); 
            } ));
        }
        
        function stopSkulpt() {
            editor.setReadOnly(false); 
            editor.setTheme("ace/theme/monokai");
            just_run = false;
            
            stopButton.style.display = "none";          
            runButton.style.display = "inline";          
            if (nostep != null && nostep.length > 0)
            {        
                stepButton.style.display = "none";
            }    
            else
            {
                stepButton.style.display = "inline";
            }    
            if (norun != null && norun.length > 0)
            {        
                runButton.style.display = "none";
            }    
            else
            {
                runButton.style.display = "inline";
            }            
            resetCanvas();                     
        }
        
        function stopEditor()
        {
            _stopped = true;
            if (inputElement != null)
            {
                // if stopped during an input...
                stopSkulpt();
                userResponse = inputElement.innerText.replace(/\n+$/, "");
                inputElement.remove();
                outputf(userResponse);
                outputf("\n"); 
                // TODO: fold this into the main promise/catch process?
                inputElement = null;
                logError("Stopped!");                
                throw "Stopped!";
            }                       
        }
        
        function userLoadCode(event) {
            var files = event.target.files;
            var file = null;
            if (files.length > 0) file = files[0];
            else return;
            var reader = new FileReader();
            reader.onload = (function (theFile) {
                return function (e) {
                    checkForPyangelo(e.target.result);
                    editor.setValue(e.target.result, -1);
                };
            })(file);
            reader.readAsText(file);
        }     

        function checkForPyangelo(code)
        {            
            var pyangeloPattern = /^(?:\s*import\s+pyangelo.*)|(?:\s*from\s+pyangelo\s+import.*)$/gm;                           
            var match = code.match(pyangeloPattern);
            
            setDisplayMode(match != null ? "canvas": display);                
        }

        function setDisplayMode(mode)
        {
            if (prevDisplay != null && prevDisplay == mode)
            {
                return;
            }
            var gutters = document.getElementsByClassName("gutter");
            if (typeof(gutters) !== 'undefined' && gutters.length > 0)
            {
                for (gutter of gutters)
                {
                    gutter.parentNode.removeChild(gutter);
                }
            }
            
            prevDisplay = mode;
            // FIXME: Setting display mode to non-canvas after it has been set to canvas causes issues
            if (mode == "canvas")
            {
                // we're in canvas demo mode
                document.getElementById('leftpane').appendChild(document.getElementById('editor'));
                document.getElementById('rightpane').appendChild(document.getElementById('pyangelo'));
                document.getElementById('bottompane').appendChild(document.getElementById('console')); 
                
                document.getElementById('bottompane').style = "display:block; height: calc(100% - 640px);";      
                
                document.getElementById('editor').style.height = "100%";   
                                       
                document.getElementById('split').style = "height: 555px; display: flex; flex-direction:row;";            
                document.getElementById('rightpane').style = "width: 330px;"
                document.getElementById('leftpane').style = "height: 545px; flex-grow: 1;";
                
                //document.getElementById('console').style = "height: 200px";
				document.getElementById('console').style = "height: 100%";
                
                document.getElementById('pyangelo').style = "display:block";  
                
                // no step-run for canvas items
                // TODO: implement optional immediate drawing mode to support this
                nostep = "1";
                stepButton.style.display = "none";     

                
            }            
            else if (mode == "top")
            {
               // editor on top, console at the bottom, splittable
                document.getElementById('pyangelo').style = "display:none";     

                document.getElementById('split').style = "display: flex; flex-direction: column"; 
                document.getElementById('split').style.width = "100%";               
                document.getElementById('split').style.height = "calc(100% - 60px)"; 
                         
                document.getElementById('editor').style.width = "100%";   
                document.getElementById('editor').style.height = "100%"; 
                document.getElementById('console').style.width = "100%"; 
                document.getElementById('console').style.height = "100%";                     
                
                document.getElementById('leftpane').appendChild(document.getElementById('editor'));
                document.getElementById('rightpane').appendChild(document.getElementById('console'));
                document.getElementById('bottompane').appendChild(document.getElementById('pyangelo'));                                  
                            
                Split(['#leftpane', '#rightpane'], {direction: 'vertical',})  
                
                document.getElementById('rightpane').style.width = "100%";
                document.getElementById('leftpane').style.width = "100%";    
                document.getElementById('bottompane').style = "display:none";                    
                
                new ResizeObserver(function(entries) {
                    // needed so that resizing the divider forces a resize on the window 
                    // and thereby updating the ace code window properly
                    window.dispatchEvent(new Event('resize'));
                }).observe(document.getElementById('leftpane'));             
            }
            else if (mode == "bottom")
            {
                // console on top, editor at the bottom, splittable
                document.getElementById('pyangelo').style = "display:none";     

                document.getElementById('split').style = "display: flex; flex-direction: column"; 
                document.getElementById('split').style.width = "100%";               
                document.getElementById('split').style.height = "calc(100% - 60px)"; 
                         
                document.getElementById('editor').style.width = "100%";   
                document.getElementById('editor').style.height = "100%"; 
                document.getElementById('console').style.width = "100%"; 
                document.getElementById('console').style.height = "100%";  

                document.getElementById('leftpane').appendChild(document.getElementById('console'));
                document.getElementById('rightpane').appendChild(document.getElementById('editor'));
                document.getElementById('bottompane').appendChild(document.getElementById('pyangelo'));                                  
                            
                Split(['#leftpane', '#rightpane'], {direction: 'vertical',})  
                
                document.getElementById('rightpane').style.width = "100%";
                document.getElementById('leftpane').style.width = "100%";      
                document.getElementById('bottompane').style = "display:none";                    
                
                new ResizeObserver(function(entries) {
                    // needed so that resizing the divider forces a resize on the window 
                    // and thereby updating the ace code window properly
                    window.dispatchEvent(new Event('resize'));
                }).observe(document.getElementById('rightpane'));             
            }
            else
            {
                // "side" is the default
                // standard editor mode: console to the right of the editor, no canvas - splittable view
                document.getElementById('pyangelo').style = "display:none";        
                //document.getElementById('split').style.height = "100%";               
                document.getElementById('split').style.height = "calc(100% - 80px)";               
                document.getElementById('editor').style.height = "100%";   
                document.getElementById('console').style.height = "100%";    
                
                document.getElementById('rightpane').style.height = "100%;"
                document.getElementById('leftpane').style.height = "100%";     
                document.getElementById('bottompane').style = "display:none";                   

                document.getElementById('leftpane').appendChild(document.getElementById('editor'));
                document.getElementById('rightpane').appendChild(document.getElementById('console'));
                document.getElementById('bottompane').appendChild(document.getElementById('pyangelo'));    
                
                Split(['#leftpane', '#rightpane'])               
            }            
        }
    </script>     
</head> 

<body> 
    <div id="container" style = "width:100%; margin: 0 auto"> 
        <form id="buttons" style = "margin: 20px auto;text-align: center; position: sticky;"> 
            <button id="runButton" type="button" onclick="runSkulpt(false);" style = "width:72px">🞂 Run</button> 
            <button id="stepButton" type="button" onclick="runSkulpt(true);" style = "width:72px">👣 Step</button> 
            <button id="stopButton" type="button" onclick="stopEditor();" style = "width:148px">🛑 Stop</button>
            <button id="copyButton" type="button" onclick="copyCode();" style = "width:72px">📋 Copy</button> 
            <button id="saveButton" type="button" onclick="saveCode(filename);" style = "width:72px">💾 Save</button>         
            <button id="loadButton" type="button" onclick="document.getElementById('file-input').click(); return false;" style = "width:72px">📂 Open</button> 
            <button id="URLButton" type="button" onclick="generateURL();" style = "width:72px">URL</button> 
            <button id="embedButton" type="button" onclick="generateEmbed();" style = "width:72px">Embed</button> 
        </form>  
        <div class="split" id="split">
            <div id ="leftpane"></div>
            <div id ="rightpane"></div>
        </div>   
        <div id ="bottompane"></div>
        
        <div id="editor" style = "border: 1px solid black">from random import *

secret = randint(1, 100)

print("I'm thinking of a number between 1 and 100...")

guess = -1

while guess != secret:
    guess = int(input(WHITE + "Enter your guess:"))
    if guess > secret:
        print(GREEN + "Lower...")
    elif guess < secret:
        print(RED + "Higher")

print(CYAN + "You got it!")
print(RESET + "Bye now!")
        </div>
        <pre id="console" onclick="if (inputElement != null) inputElement.focus();"></pre>     
        <canvas id="pyangelo" height = 545 width = 326 style="border: 1px solid black; flex: 1 1 0px;" tabindex='1'></canvas>        
    </div>
    <input id="file-input" type="file" name="name" style="display: none;"/>
    
    <!---- setting up global vars for the editor and console etc. ----->
    <script>       
        // setting up the ace editor
        var pyConsole = document.getElementById("console"); 
        
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/python");        
        editor.setOptions({  
          fontSize: "12pt"
        });        
        editor.setHighlightActiveLine(true);
		
		document.getElementById('file-input').addEventListener('change', userLoadCode, false);  

        // grabbing the URL parameters and processing them
        urlParams = new URLSearchParams(window.location.search);        
        
        // embedded code in the URL
        esc = urlParams.get('code')                
        if (esc != null && esc.length > 0)
        {            
            //codeString = atou(esc);
            codeString = decodeFromUTF16(esc);
            checkForPyangelo(codeString);
            editor.setValue(codeString, -1);
            //document.getElementById("editor").innerHTML = codeString;            
        }
             
        // project mode: load from code from existing .py file under /projects
        // only works when hosted on web server (no filesystem mode)
        project = urlParams.get('project');
        if (project != null && project.length > 0)
        {
            var client = new XMLHttpRequest();
            client.open("GET", "projects/" + project + ".py");
            client.onreadystatechange = function () {
                if (client.readyState == 4) {
                    project_src = client.responseText;
                    checkForPyangelo(project_src);
                    editor.setValue(project_src, -1);
                }
            };
            client.send();            
        }            

        // configurable buttons
        var runButton = document.getElementById("runButton"); 
        var saveButton = document.getElementById("saveButton"); 
        var loadButton = document.getElementById("loadButton"); 
        var stepButton = document.getElementById("stepButton"); 
        var copyButton = document.getElementById("copyButton");       
        var stopButton = document.getElementById("stopButton");  
        var URLButton = document.getElementById("URLButton");  
        var embedButton = document.getElementById("embedButton");  
		
		// hide stop button on load
        stopButton.style.display = "none";  

        // allows save (and load)
        nosave = urlParams.get('nosave')
        if (nosave != null && nosave.length > 0)
        {        
            saveButton.style.display = "none";
            loadButton.style.display = "none";
        }    
        else
        {        
            saveButton.style.display = "inline";
            loadButton.style.display = "inline";
        }       

        var filename = null;  
        // default file name (for saving)
        filename = urlParams.get('name')
        if (filename == null || filename.length == 0)
        {        
            filename = "my_code";
        }          
        
        // disable step-run button
        nostep = urlParams.get('nostep')
        if (nostep != null && nostep.length > 0)
        {        
            stepButton.style.display = "none";
            stopButton.style.width = "72px";
        }    
        else
        {
            stepButton.style.display = "inline";
        }   
        
        // disable run button
        norun = urlParams.get('norun')
        if (norun != null && norun.length > 0)
        {        
            runButton.style.display = "none";
            stopButton.style.width = "72px";
            stepButton.innerHTML = "🞂 Step";
        }    
        else
        {
            runButton.style.display = "inline";
        }           

        // disable copy code button
        nocopy = urlParams.get('nocopy')
        if (nocopy != null && nocopy.length > 0)
        {
            copyButton.style.display = "none";
        }    
        else
        {
            copyButton.style.display = "inline";
        }           

        // get URL button
        URLButton.style.display = "none";  
        urlButtonOn = urlParams.get('url')
        if (urlButtonOn != null && urlButtonOn.length > 0)
        {        
            URLButton.style.display = "inline";
        }    
        else
        {        
            URLButton.style.display = "none";
        }     
        
        // get embed button
        embedButton.style.display = "none";  
        embedButtonOn = urlParams.get('embed')
        if (embedButtonOn != null && embedButtonOn.length > 0)
        {        
            embedButton.style.display = "inline";
        }    
        else
        {        
            embedButton.style.display = "none";
        }          

        // hides the drawing canvas
        nocanvas = urlParams.get('nocanvas')
        if (nocanvas != null && nocanvas.length > 0)
        {        
            var rightpane = document.getElementById("rightpane");
            rightpane.style.display = "none";
            var leftpane = document.getElementById("leftpane");
            leftpane.style.width = "100%";
        }          
        
        // canvas demo mode: canvas to the right of the editor, console at the bottom
        var prevDisplay = null;  
        var display = urlParams.get('display');
        // TODO: the order below is important
        
        if (display == null || display.length == 0)
        {
            display = "side";
        }    
        setDisplayMode(display);
        
        var just_run = false;
        var _stopped = false;
        var inputElement = null;
        
        resetCanvas();
        
    </script>    

</body> 

</html> 