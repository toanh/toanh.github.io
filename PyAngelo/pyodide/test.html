<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <!--
    <script src="https://code.jquery.com/jquery-latest.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal/js/jquery.terminal.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/jquery.terminal/css/jquery.terminal.min.css" rel="stylesheet"/>
    <link href="renderedhtml.css" rel="stylesheet"/>-->
    <script>
      window.languagePluginUrl = "./";
    </script>
    <script src="./pyodide_dev.js"></script>
  </head>
  <body>
    <script>
      languagePluginLoader.then(() => {
        pyodide.remotePath = ["/", "/pyangelo"];
        pyodide.runPythonAsync(`
            from pyangelo import *
            from random import *
            
            class Sprite:
                def __init__(self, name, x, y):
                    self.name = name
                    self.x = x
                    self.y = y
                    self.dy = 0
            
            graphics = PyAngelo()
            
            graphics.loadImage("https://toanh.github.io/PyAngelo/images/PyAngelo.png")
            
            i = 0
            
            n = 0
            max_sprites = 1000
            sprites = []
            while n < max_sprites:
                sprites.append(Sprite("https://toanh.github.io/PyAngelo/images/PyAngelo.png", randint(0, 450), randint(0, 350)))
                n += 1
            
            
            @graphics.loop
            def Game():
                global i
                i += 0.01
                if i > 1.0:
                    i = 0
                    
                n = 0
                while n < max_sprites:
                    sprites[n].dy -= 1
                    sprites[n].y += sprites[n].dy
                    
                    if sprites[n].y <= 0:
                        sprites[n].y = 0
                        sprites[n].dy = -sprites[n].dy
                    n += 1
                    
                graphics.clear(i, 0, 0)
                
                
                n = 0
                while n < max_sprites:
                    graphics.drawImage(sprites[n].name, sprites[n].x,sprites[n].y)
                    n += 1
                

        `);      
        /*
        function pushCode(line) {
          handleResult(c.push(line))
        }

        var term = $('body').terminal(
          pushCode,
          {
            greetings: "Welcome to the Pyodide terminal emulator 🐍",
            prompt: "[[;red;]>>> ]"
          }
        );

        window.term = term;
        pyodide.runPython(`
          import io, code, sys
          from js import term, pyodide

          class Console(code.InteractiveConsole):
              def runcode(self, code):
                  sys.stdout = io.StringIO()
                  sys.stderr = io.StringIO()
                  term.runPython("\\n".join(self.buffer))
          _c = Console(locals=globals())
        `)

        var c = pyodide.pyimport('_c')

        function handleResult(result) {
          if (result) {
            term.set_prompt('[[;gray;]... ]')
          } else {
            term.set_prompt('[[;red;]>>> ]')
            var stderr = pyodide.runPython("sys.stderr.getvalue()").trim()
            if (stderr) {
              term.echo(`[[;red;]${stderr}]`)
            } else {
              var stdout = pyodide.runPython("sys.stdout.getvalue()")
              if (stdout) {
                term.echo(stdout.trim())
              }
            }
          }
        }

        term.runPython = function(code) {
          pyodide.runPythonAsync(code).then(
            term.handlePythonResult, term.handlePythonError
          )
        }

        term.handlePythonResult = function(result) {
          if (result === undefined) {
            return
          } else if (result['_repr_html_'] !== undefined) {
            term.echo(result['_repr_html_'], {raw: true})
          } else {
            term.echo(result.toString())
          }
        }

        term.handlePythonError = function(result) {
          term.error(result.toString())
        }
      */
      });

    </script>
    <div id="outputBox">
        <canvas id = "canvas" width="500" height ="400" onclick="document.getElementById('v_key_trigger').focus();">
            <!-- force virtual keyboard to trigger when focus is on canvas -->
            <!-- <input type="text" id="v_key_trigger" style="z-index: -1;"> -->
        </canvas>
    </div>    
  </body>
</html>
